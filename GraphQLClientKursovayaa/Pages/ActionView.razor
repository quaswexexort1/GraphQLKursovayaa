@page "/ActionView"

@using BlazorBootstrap
@using GraphQLClientKursovayaa.DataAccess
@using GraphQLClientKursovayaa.DataAccess.Model

@inject NavigationManager NavigationManager

<h3>Список действий</h3>

@if (AllActions.Count == 0)
{
    <p><em>Loading...</em></p>
}
else
{
    <table class="table">
        <thead>
            <tr>
                <th>Название</th>
                <th>Описание</th>
                <th>Цена</th>
                <th>Завершено?</th>
                <th>Дата начала</th>
                <th>Дата окончания(если есть)</th>
                <th>IdДела</th>
                <th>Редактировать</th>
                <th>Удалить</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var act in ShowActions)
            {
                <tr>
                    <td>@act.Title</td>
                    <td>@act.Description</td>
                    <td>@act.Cost</td>
                    <td>@act.IsCompleted</td>
                    <td>@act.DatePerformed</td>
                    <td>@act.EndDate</td>
                    <td>@act.CaseId</td>
                    <td>
                        <a href="/EditAction/@act.ActionId">
                            <img src="images/edit.png" class="imgedit" />
                        </a>
                    </td>
                    <td>
                        <a href="/DeleteAction/@act.ActionId">
                            <img src="images/delete.png" class="imgdelete" />
                        </a>
                    </td>
                </tr>
            }
        </tbody>
    </table>

    @if (showCustomPagination)
    {
        <div class="d-flex justify-content-between align-items-center mt-3">
            <div>
                <span class="text-muted">
                    Показано @((currentPage - 1) * pageSize + 1)-
                    @Math.Min(currentPage * pageSize, totalCount)
                    из @totalCount записей
                </span>
            </div>
            <Pagination ActivePageNumber="@currentPage"
                        TotalPages="@totalPages"
                        Size="PaginationSize.Small"
                        Alignment="Alignment.End"
                        ShowPageInfo="true"
                        PageChanged="@OnCustomPageChanged" />
        </div>
    }

    <a href="/CreateAction" class="btn btn-primary mt-2">Создать действие</a>
}

@code {
    private List<DataAccess.Model.Action> AllActions = new();

    private List<DataAccess.Model.Action> ShowActions = new();
    private int totalCount = 0;
    private int currentPage = 1;
    private int pageSize = 10;
    private int totalPages => (int)Math.Ceiling(totalCount / (double)pageSize);
    private bool showCustomPagination = false;
    private static readonly int[] PageItemsSource = new int[] { 5, 10, 20, 50, 100 };

    protected override async Task OnInitializedAsync()
    {
        try
        {
            string completeQuery =
                "query{allActions{actionId,title,description,cost,isCompleted,datePerformed,endDate,caseId}}";

            string graphQLQueryType = "allActions";

            var result = await Query.ExceuteQueryReturnListAsyn<DataAccess.Model.Action>(
                graphQLQueryType,
                completeQuery);

            AllActions = result;
            totalCount = AllActions.Count;
            if (totalCount > pageSize)
                showCustomPagination = true;

            await LoadDataAsync();
        }
        catch
        {
            throw;
        }
    }

    private async Task LoadDataAsync()
    {
        await Task.Delay(50);
        ShowActions = GetActionsForPage(currentPage, pageSize);
    }

    private async Task OnCustomPageChanged(int page)
    {
        currentPage = page;
        await LoadDataAsync();
    }

    private List<DataAccess.Model.Action> GetActionsForPage(int page, int size)
    {
        return AllActions
            .Skip((page - 1) * size)
            .Take(size)
            .ToList();
    }
}
