@page "/CaseView"

@using BlazorBootstrap
@using GraphQLClientKursovayaa.DataAccess
@using GraphQLClientKursovayaa.DataAccess.Model

@inject NavigationManager NavigationManager

<h3>Список дел</h3>

@if (AllCases.Count == 0)
{
    <p><em>Loading...</em></p>
}
else
{
    <table class="table">
        <thead>
            <tr>
                <th>ID</th>
                <th>Название</th>
                <th>Описание</th>
                <th>Цена</th>
                <th>Выполненные действия</th>
                <th>Адвокаты</th>
                <th>Счёт</th>
                <th>Проценты премии</th>
                <th>Дело выиграно?</th>
                <th>Дата начала</th>
                <th>Дата окончания(если есть)</th>
                <th>Редактировать</th>
                <th>Удалить</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var c in ShowCases)
            {
                <tr>
                    <td><strong>@c.CaseId</strong></td>
                    <td>@c.Title</td>
                    <td>@c.Description?</td>
                    <td>@c.NominalCost</td>
                    <td>
                        <span class="badge bg-success">
                            @c.CompletedActionsCount
                        </span>
                    </td>
                    <td><span class="badge bg-info">@c.LawyersCount</span></td>
                    <td><strong>@c.TotalBill.ToString("C")</strong></td>
                    <td>@c.PremiumPercent</td>
                    <td>@c.IsWon</td>
                    <td>@c.StartDate</td>
                    <td>@c.EndDate</td>
                    <td>
                        <a href="/EditCase/@c.CaseId">
                            <img src="images/edit.png" class="imgedit" />
                        </a>
                    </td>
                    <td>
                        <a href="/DeleteCase/@c.CaseId">
                            <img src="images/delete.png" class="imgdelete" />
                        </a>
                    </td>
                </tr>
            }
        </tbody>
    </table>

    @if (showCustomPagination)
    {
        <div class="d-flex justify-content-between align-items-center mt-3">
            <div>
                <span class="text-muted">
                    Показано @((currentPage - 1) * pageSize + 1)-
                    @Math.Min(currentPage * pageSize, totalCount)
                    из @totalCount записей
                </span>
            </div>
            <Pagination ActivePageNumber="@currentPage"
                        TotalPages="@totalPages"
                        Size="PaginationSize.Small"
                        Alignment="Alignment.End"
                        ShowPageInfo="true"
                        PageChanged="@OnCustomPageChanged" />
        </div>
    }

    <a href="/CreateCase" class="btn btn-primary mt-2">Создать дело</a>
}

@code {
    private List<Case> AllCases = new();
    private List<Case> ShowCases = new();

    private int totalCount = 0;
    private int currentPage = 1;
    private int pageSize = 10;
    private int totalPages => (int)Math.Ceiling(totalCount / (double)pageSize);
    private bool showCustomPagination = false;
    private static readonly int[] PageItemsSource = new int[] { 5, 10, 20, 50, 100 };

    protected override async Task OnInitializedAsync()
    {
        try
        {
            string casesQuery = "query{allCases{caseId,title,description,nominalCost,premiumPercent,isWon,startDate,endDate}}";
            AllCases = await Query.ExceuteQueryReturnListAsyn<Case>("allCases", casesQuery);

            string actionsQuery = "query{allActions{actionId,caseId,isCompleted,cost}}";
            var allActions = await Query.ExceuteQueryReturnListAsyn<DataAccess.Model.Action>("allActions", actionsQuery);

            List<Advokat> allAdvokats = new List<Advokat>();
            try
            {
                string advokatQuery = "query{allAdvokatsOnly{advokatId,caseId}}";
                allAdvokats = await Query.ExceuteQueryReturnListAsyn<Advokat>("allAdvokatsOnly", advokatQuery);
            }
            catch (Exception advokatEx)
            {
                Console.WriteLine($"Адвокаты не загрузились: {advokatEx.Message}");
            }

            foreach (var caseItem in AllCases)
            {
                caseItem.CompletedActionsCount = allActions.Count(a => a.CaseId == caseItem.CaseId);
                caseItem.LawyersCount = allAdvokats.Count(l => l.CaseId == caseItem.CaseId);
                caseItem.TotalBill = allActions.Where(a => a.CaseId == caseItem.CaseId) .Sum(a => a.Cost); 


            }

            totalCount = AllCases.Count;
            if (totalCount > pageSize)
                showCustomPagination = true;

            await LoadDataAsync();
        }
        catch (Exception ex)
        {
            throw new Exception($"Ошибка загрузки: {ex.Message}");
        }
    }

    private async Task LoadDataAsync()
    {
        await Task.Delay(50);
        ShowCases = GetCasesForPage(currentPage, pageSize);
    }

    private async Task OnCustomPageChanged(int page)
    {
        currentPage = page;
        await LoadDataAsync();
    }

    private List<Case> GetCasesForPage(int page, int size)
    {
        return AllCases
            .Skip((page - 1) * size)
            .Take(size)
            .ToList();
    }
}
