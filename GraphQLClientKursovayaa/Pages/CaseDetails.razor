@page "/CaseDetails/{Id:int}"
@using GraphQLClientKursovayaa.DataAccess
@using GraphQLClientKursovayaa.DataAccess.Model
@inject NavigationManager NavigationManager

<h3>Информация по делу</h3>

@if (caseModel is null)
{
    <p>Загрузка...</p>
}
else
{
    <h4>@caseModel.Title</h4>
    <p>@caseModel.Description</p>

    <p>
        Клиент: @caseModel.Client?.Name
    </p>

    <p>
        Номинальная стоимость: @caseModel.NominalCost<br />
        Процент премии: @caseModel.PremiumPercent<br />
        Выиграно: @(caseModel.IsWon ? "Да" : "Нет")<br />
        Дата начала: @caseModel.StartDate.ToShortDateString()
    </p>

    <h5>Адвокаты по делу</h5>
    @if (caseModel.Advokats is { Count: > 0 })
    {
        <ul>
            @foreach (var a in caseModel.Advokats)
            {
                <li>@a.Name (@a.Specialization)</li>
            }
        </ul>
    }
    else
    {
        <p>Адвокаты не назначены.</p>
    }

    <h5>Действия по делу</h5>
    @if (caseModel.Actions is { Count: > 0 })
    {
        <table class="table table-striped">
            <thead>
                <tr>
                    <th>Название</th>
                    <th>Дата</th>
                    <th>Стоимость</th>
                    <th>Статус</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var act in caseModel.Actions)
                {
                    <tr>
                        <td>@act.Title</td>
                        <td>@act.DatePerformed.ToShortDateString()</td>
                        <td>@act.Cost</td>
                        <td>@(act.IsCompleted ? "Завершено" : "В работе")</td>
                    </tr>
                }
            </tbody>
        </table>
    }
    else
    {
        <p>Действий пока нет.</p>
    }

    <button class="btn btn-secondary"
            @onclick="@(() => NavigationManager.NavigateTo("CaseView"))">
        Назад к списку дел
    </button>
}

@code {
    [Parameter] public int Id { get; set; }

    private Case? caseModel;

    protected override async Task OnInitializedAsync()
    {
        // Составь запрос под свою схему GraphQL, главное – запросить client, advokats, actions
        string query =
            "query{" +
                "caseById(id:" + Id + "){" +
                    "caseId,title,description,nominalCost,premiumPercent,isWon,startDate," +
                    "client{clientId,name}," +
                    "advokats{advokatId,name,specialization}," +
                    "actions{actionId,title,datePerformed,cost,isCompleted}" +
                "}" +
            "}";

        string graphQLQueryType = "caseById";

        var result = await Query.ExceuteQueryAsyn<Case>(graphQLQueryType, query);

        if (result == null)
        {
            NavigationManager.NavigateTo("CaseView", forceLoad: true);
            return;
        }

        caseModel = result;
    }
}
