@page "/ClientView"

@using BlazorBootstrap
@using GraphQLClientKursovayaa.DataAccess
@using GraphQLClientKursovayaa.DataAccess.Model

@inject NavigationManager NavigationManager

<h3>Список клиентов</h3>

@if (AllClients.Count == 0)
{
    <p><em>Loading...</em></p>
}
else
{
    <table class="table">
        <thead>
            <tr>
                <th>Имя</th>
                <th>Телефон</th>
                <th>Почта</th>
                <th>Aдрес</th>
                <th>Количество дел</th>
                <th>Детали</th>
                <th>Редактировать</th>
                <th>Удалить</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var c in ShowClients)
            {
                <tr>
                    <td>@c.Name</td>
                    <td>@c.Phone</td>
                    <td>@c.Email</td>
                    <td>@c.Address</td>
                    <td>
                        <span class="badge bg-primary">@c.CasesCount</span>  
                    </td>
                    <td>
                        <a href="@($"/ClientDetails/{c.ClientId}")">
                            <span class="btn btn-sm btn-info">Открыть</span>
                        </a>
                    </td>
                    <td>
                        <a href="/EditClient/@c.ClientId">
                            <img src="images/edit.png" class="imgedit" />
                            <span class="btn btn-sm btn-info">Редактировать</span>
                        </a>
                    </td>
                    <td>
                        <a href="/DeleteClient/@c.ClientId">
                            <img src="images/delete.png" class="imgedit" />
                            <span class="btn btn-sm btn-info">
                                Удалить
                            </span>
                        </a>
                    </td>
                </tr>
            }
        </tbody>
    </table>

    @if (showCustomPagination)
    {
        <div class="d-flex justify-content-between align-items-center mt-3">
            <div>
                <span class="text-muted">
                    Показано @((currentPage - 1) * pageSize + 1)-
                    @Math.Min(currentPage * pageSize, totalCount)
                    из @totalCount записей
                </span>
            </div>
            <Pagination ActivePageNumber="@currentPage"
                        TotalPages="@totalPages"
                        Size="PaginationSize.Small"
                        Alignment="Alignment.End"
                        ShowPageInfo="true"
                        PageChanged="@OnCustomPageChanged" />
        </div>
    }

    <a href="/CreateClient" class="btn btn-primary mt-2">Создать клиента</a>
}

@code {
    private List<Client> AllClients = new();
    private List<Client> ShowClients = new();

    private int totalCount = 0;
    private int currentPage = 1;
    private int pageSize = 10;
    private int totalPages => (int)Math.Ceiling(totalCount / (double)pageSize);
    private bool showCustomPagination = false;
    private static readonly int[] PageItemsSource = new int[] { 5, 10, 20, 50, 100 };

    protected override async Task OnInitializedAsync()
    {
        try
        {
            // 1. Загружаем клиентов (твой код)
            string completeQuery = "query{allClientsOnly{clientId,name,phone,email,address}}";
            string graphQLQueryType = "allClientsOnly";
            var result = await Query.ExceuteQueryReturnListAsyn<Client>(graphQLQueryType, completeQuery);
            AllClients = result;

            // 2. Загружаем ВСЕ дела для подсчёта ✅
            string casesQuery = "query{allCases{caseId,clientId}}";  // НУЖЕН clientId!
            var allCases = await Query.ExceuteQueryReturnListAsyn<Case>("allCases", casesQuery);

            // 3. Подсчёт дел ПО КЛИЕНТУ ✅
            foreach (var clientItem in AllClients)
            {
                clientItem.CasesCount = allCases.Count(c => c.ClientId == clientItem.ClientId);
            }

            totalCount = AllClients.Count;
            if (totalCount > pageSize)
                showCustomPagination = true;

            await LoadDataAsync();
        }
        catch (Exception ex)
        {
            throw new Exception($"Ошибка загрузки: {ex.Message}");
        }
    }

    private async Task LoadDataAsync()
    {
        await Task.Delay(50);
        ShowClients = GetClientsForPage(currentPage, pageSize);
    }

    private async Task OnCustomPageChanged(int page)
    {
        currentPage = page;
        await LoadDataAsync();
    }

    private List<Client> GetClientsForPage(int page, int size)
    {
        return AllClients
            .Skip((page - 1) * size)
            .Take(size)
            .ToList();
    }
}
