@page "/AdvokatView"

@using BlazorBootstrap
@using GraphQLClientKursovayaa.DataAccess
@using GraphQLClientKursovayaa.DataAccess.Model

@inject NavigationManager NavigationManager

<h3>Список адвокатов</h3>

@if (AllAdvokats.Count == 0)
{
    <p><em>Loading...</em></p>
}
else
{
    <table class="table">
        <thead>
            <tr>
                <th>Имя</th>
                <th>Специализация</th>
                <th>Номер лицензии</th>
                <th>Почасовая ставка</th>
                <th>Редактировать</th>
                <th>Удалить</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var a in ShowAdvokats)
            {
                <tr>
                    <td>@a.Name</td>
                    <td>@a.Specialization</td>
                    <td>@a.LicenseNumber</td>
                    <td>@a.HourlyRate</td>
                    <td>
                        <a href="/EditAdvokat/@a.AdvokatId">
                            <img src="images/edit.png" class="imgedit" />
                        </a>
                    </td>
                    <td>
                        <a href="/DeleteAdvokat/@a.AdvokatId">
                            <img src="images/delete.png" class="imgdelete" />
                        </a>
                    </td>
                </tr>
            }
        </tbody>
    </table>

    @if (showCustomPagination)
    {
        <div class="d-flex justify-content-between align-items-center mt-3">
            <div>
                <span class="text-muted">
                    Показано @((currentPage - 1) * pageSize + 1)-
                    @Math.Min(currentPage * pageSize, totalCount)
                    из @totalCount записей
                </span>
            </div>
            <Pagination ActivePageNumber="@currentPage"
                        TotalPages="@totalPages"
                        Size="PaginationSize.Small"
                        Alignment="Alignment.End"
                        ShowPageInfo="true"
                        PageChanged="@OnCustomPageChanged" />
        </div>
    }

    <a href="/CreateAdvokat" class="btn btn-primary mt-2">Создать адвоката</a>
}

@code {
    private List<Advokat> AllAdvokats = new();
    private List<Advokat> ShowAdvokats = new();

    private int totalCount = 0;
    private int currentPage = 1;
    private int pageSize = 10;
    private int totalPages => (int)Math.Ceiling(totalCount / (double)pageSize);
    private bool showCustomPagination = false;
    private static readonly int[] PageItemsSource = new int[] { 5, 10, 20, 50, 100 };

    protected override async Task OnInitializedAsync()
    {
        try
        {
            string completeQuery =
                "query{allAdvokatsOnly{advokatId,name,specialization,licenseNumber,hourlyRate}}";

            string graphQLQueryType = "allAdvokatsOnly";

            var result = await Query.ExceuteQueryReturnListAsyn<Advokat>(
                graphQLQueryType,
                completeQuery);

            AllAdvokats = result;
            totalCount = AllAdvokats.Count;
            if (totalCount > pageSize)
                showCustomPagination = true;

            await LoadDataAsync();
        }
        catch
        {
            throw;
        }
    }

    private async Task LoadDataAsync()
    {
        await Task.Delay(50);
        ShowAdvokats = GetAdvokatsForPage(currentPage, pageSize);
    }

    private async Task OnCustomPageChanged(int page)
    {
        currentPage = page;
        await LoadDataAsync();
    }

    private List<Advokat> GetAdvokatsForPage(int page, int size)
    {
        return AllAdvokats
            .Skip((page - 1) * size)
            .Take(size)
            .ToList();
    }
}
